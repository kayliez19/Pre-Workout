---
title: "pre-workout"
author: "Kaylie Zapanta"
date: "2026-01-09"
output: html_document
---

```{r setup, include=FALSE}

# =========================
# Likert (ordinal) group comparison + plots
# =========================

# Packages
library(dplyr)
library(tidyr)
library(ggplot2)
library(purrr)
library(stringr)
library(forcats)
library(broom)
library(readxl)
library(scales)

```

#Load Data
```{r}

df <- read_excel("~/Desktop/df_preworkout.xlsx")

```


```{r}

# -------------------------
# 1) Settings: ID column + PRODUCT + question columns
# -------------------------
id_col <- "SubjectID"   # <-- change if your subject identifier column has a different name
group_col <- "PRODUCT"

# Option A: explicitly list your 15 items (recommended)
question_cols <- c(
  "Q1",	"Q2",	"Q3",	"Q4",	"Q5",	"Q21", "Q25_1",	"Q25_2",	"Q25_3",	"Q25_4",	"Q25_5",	"Q25_6",	"Q26",	"Q27",	"Q28", "Q31"
)

```


# -------------------------
# 2) Basic checks
# -------------------------
```{r}
if (!all(c(id_col, group_col) %in% names(df))) {
  stop(paste0("Missing required column(s). Need: ", id_col, " and ", group_col))
}

missing_q <- setdiff(question_cols, names(df))
if (length(missing_q) > 0) {
  stop(paste0("These question columns were not found in your data: ", paste(missing_q, collapse = ", ")))
}

df2 <- df %>%
  mutate(
    SubjectID = as.factor(.data[[id_col]]),
    PRODUCT   = as.factor(.data[[group_col]])
  ) %>%
  filter(!is.na(SubjectID), !is.na(PRODUCT))
if (nlevels(df2$PRODUCT) != 2) {
  stop("PRODUCT must have exactly 2 levels for this script (crossover with two products).")
}


```


# -------------------------
# 3) Reshape long + parse Likert scores
#    Handles numeric (1,2,3) and strings like '1- never'
# -------------------------
```{r}


df_long <- df2 %>%
  pivot_longer(cols = all_of(question_cols), names_to = "question", values_to = "raw") %>%
  mutate(
    score_num = suppressWarnings(as.numeric(raw)),
    score_num = ifelse(
      is.na(score_num),
      suppressWarnings(as.numeric(str_extract(as.character(raw), "^[0-9]+"))),
      score_num
    )
  ) %>%
  filter(!is.na(score_num))

# Shared Likert levels for consistent plotting across questions
likert_levels <- sort(unique(df_long$score_num))
df_long <- df_long %>%
  mutate(score = factor(score_num, levels = likert_levels, ordered = TRUE))


```

# -------------------------
# 4) Paired tests per question (Wilcoxon signed-rank)
#    Requires each SubjectID has responses for BOTH products for a given question
# -------------------------
# Rank-biserial correlation for paired signed-rank:
# r_rb = (2*V)/(n*(n+1)) - 1, where V is sum of positive ranks and n is # non-zero diffs

```{r}

rank_biserial_paired <- function(xA, xB) {
  d <- xA - xB
  d <- d[!is.na(d)]
  d <- d[d != 0]
  n <- length(d)
  if (n < 1) return(NA_real_)
  r <- rank(abs(d))
  V <- sum(r[d > 0])
  (2 * V) / (n * (n + 1)) - 1
}

prod_levels <- levels(df_long$PRODUCT)
prod_A <- prod_levels[1]
prod_B <- prod_levels[2]

paired_results <- df_long %>%
  select(SubjectID, PRODUCT, question, score_num) %>%
  group_by(question) %>%
  group_modify(~{
    dat_w <- .x %>%
      pivot_wider(names_from = PRODUCT, values_from = score_num)

    # complete pairs only
    dat_w <- dat_w %>% filter(complete.cases(.))

    if (nrow(dat_w) < 2) {
      return(tibble(
        n_pairs = nrow(dat_w),
        median_diff_A_minus_B = NA_real_,
        p_value = NA_real_,
        rank_biserial = NA_real_
      ))
    }
    xA <- dat_w[[prod_A]]
    xB <- dat_w[[prod_B]]

    wt <- wilcox.test(xA, xB, paired = TRUE, exact = FALSE)

    tibble(
      n_pairs = nrow(dat_w),
      median_diff_A_minus_B = median(xA - xB, na.rm = TRUE),
      p_value = wt$p.value,
      rank_biserial = rank_biserial_paired(xA, xB)
    )
  }) %>%
  ungroup() %>%
  mutate(p_adj_fdr = p.adjust(p_value, method = "fdr")) %>%
  arrange(p_value)

print(paired_results)


```

# -------------------------
# 6) Plot B: Colored faceted boxplots + jitter + p-value stars (paired tests)
# -------------------------
```{r}
# Define PRODUCT colors (auto-assign to your two level names)
product_colors <- setNames(c("#1F77B4", "#E45756"), prod_levels)

# Build labels (stars based on FDR; show raw p)
annot_df <- paired_results %>%
  mutate(
    sig = case_when(
      p_adj_fdr < 0.001 ~ "***",
      p_adj_fdr < 0.01  ~ "**",
      p_adj_fdr < 0.05  ~ "*",
      TRUE              ~ ""
    ),
    label = ifelse(
      is.na(p_value), "",
      ifelse(sig == "",
             paste0("p = ", signif(p_value, 2)),
             paste0(sig, "\n", "p = ", signif(p_value, 2)))
    )
  ) %>%
  select(question, label) %>%
  left_join(
    df_long %>%
      group_by(question) %>%
      summarise(y_pos = max(score_num, na.rm = TRUE) + 0.5, .groups = "drop"),
    by = "question"
  )

p_box <- ggplot(df_long, aes(x = PRODUCT, y = score_num, fill = PRODUCT, color = PRODUCT)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.6) +
  geom_jitter(width = 0.15, alpha = 0.35, size = 1.6) +
  facet_wrap(~question, ncol = 5, scales = "free_y") +
  geom_text(
    data = annot_df,
    aes(x = 1.5, y = y_pos, label = label),
    inherit.aes = FALSE,
    size = 3.5
  ) +
  scale_fill_manual(values = product_colors) +
  scale_color_manual(values = product_colors) +
  labs(
    title = "Likert scores by PRODUCT (crossover; paired analysis)",
    subtitle = "* indicates FDR-adjusted p < 0.05; label shows raw paired Wilcoxon p-value",
    x = "PRODUCT",
    y = "Likert score",
    fill = "PRODUCT",
    color = "PRODUCT"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid.minor = element_blank(),
    strip.text = element_text(face = "bold"),
    legend.position = "top"
  )

print(p_box)

```
```{r}

# ============================================================
# Pull significant questions (Q13, Q14) and make separate
# colored boxplots with paired-test significance labels
# Assumes you already ran the full script and have:
#   df_long, paired_results, product_colors, prod_levels
# ============================================================

library(dplyr)
library(ggplot2)

sig_qs <- c("Q26", "Q31")

custom_titles <- c(
  Q26 = "Q26. Experienced Jitters/Other Sensations?",
  Q31 = "Q31. Q31. Was Sleep Impacted?"
)

# Build per-question annotation (stars based on FDR; show raw paired p)
annot_2q <- paired_results %>%
  filter(question %in% sig_qs) %>%
  mutate(
    sig = case_when(
      p_adj_fdr < 0.001 ~ "***",
      p_adj_fdr < 0.01  ~ "**",
      p_adj_fdr < 0.05  ~ "*",
      TRUE              ~ ""
    ),
    label = paste0(sig, "\n", "p = ", signif(p_value, 2))
  ) %>%
  select(question, label) %>%
  left_join(
    df_long %>%
      filter(question %in% sig_qs) %>%
      group_by(question) %>%
      summarise(y_pos = max(score_num, na.rm = TRUE) + 0.5, .groups = "drop"),
    by = "question"
  )

# Data for just Q13 and Q14
df_2q <- df_long %>% filter(question %in% sig_qs)

# Function to make one plot per question
plot_one_question <- function(q) {
  ann <- annot_2q %>% filter(question == q)
  ggplot(df_2q %>% filter(question == q),
         aes(x = PRODUCT, y = score_num, fill = PRODUCT, color = PRODUCT)) +
    geom_boxplot(outlier.shape = NA, alpha = 0.6) +
    geom_jitter(width = 0.15, alpha = 0.35, size = 1.8) +
    geom_text(
      data = ann,
      aes(x = 1.5, y = y_pos, label = label),
      inherit.aes = FALSE,
      size = 4
    ) +
    scale_fill_manual(values = product_colors) +
    scale_color_manual(values = product_colors) +
    labs(
      title = paste0(q, " (paired crossover)"),
      subtitle = "* indicates FDR-adjusted p < 0.05; label shows raw paired p-value",
      x = "",
      y = "Likert score",
      fill = "PRODUCT",
      color = "PRODUCT"
    ) +
    theme_minimal(base_size = 12) +
    theme(
      legend.position = "top",
      panel.grid.minor = element_blank()
    )
}

p_Q26 <- plot_one_question("Q26")
p_Q31 <- plot_one_question("Q31")

print(p_Q26)
print(p_Q31)

# Optional: save
# ggsave("Q13_boxplot_significance.png", p_Q13, width = 6, height = 5, dpi = 300)
# ggsave("Q14_boxplot_significance.png", p_Q14, width = 6, height = 5, dpi = 300)



```

